# 更新日志 v1.2.0

## 📅 发布日期

2024-12-12

## 🎉 新增功能

### 1. 表分类节点右键菜单 🆕

在数据库树形视图中，"表"分类节点（📋 表）现在也支持右键菜单。

**功能特性**：
- ✨ 新建表 - 在当前数据库中创建新表
- 🔄 刷新 - 刷新表列表
- 📍 位置更直观 - 就在表列表旁边
- 🎯 操作更便捷 - 减少鼠标移动

**使用场景**：
- 快速创建新表，无需返回数据库节点
- 快速刷新表列表，操作位置更精准
- 多数据库操作时更高效

详细说明：[表分类节点菜单](./TABLE_CATEGORY_MENU.md)

### 2. 编辑表界面 - 信息可复制 🆕

在编辑表界面中，所有表信息现在都可以选择和复制。

**功能特性**：
- 📝 连接信息和表名文本可选择（鼠标悬停显示文本光标）
- 📝 表信息标签（主键、注释）文本可选择
- 📋 右键菜单"复制选中字段" - 复制选中的字段信息
- 📋 右键菜单"复制所有字段" - 复制完整表结构（包括表名、字段、主键、索引）
- 📊 复制格式使用Tab分隔，可直接粘贴到Excel
- ✅ 显示友好的成功提示

**使用场景**：
- 快速复制表名到SQL编辑器
- 导出字段列表到文档
- 分享表结构给同事
- 比对不同表的字段差异

详细说明：[编辑表复制功能](./EDIT_TABLE_COPY_FEATURE.md)

### 3. 删除表功能 🆕

在数据库树形视图的表节点右键菜单中新增"删除表"功能。

**功能特性**：
- 🗑️ 右键点击表节点，选择"删除表"
- 🔒 双重确认机制，防止误删：
  - 第一次确认：标准确认对话框
  - 第二次确认：手动输入表名验证
- ⚡ 异步执行，不阻塞界面
- 🔄 自动清理缓存和更新树形视图
- 📱 友好的状态提示和错误处理
- ✅ 支持所有主流数据库类型（MySQL/PostgreSQL/SQL Server/SQLite/Oracle）

**安全保障**：
- ⚠️ 明确警告"此操作将删除表中的所有数据，且无法恢复"
- 🔐 需要完全匹配表名（区分大小写）
- ❌ 默认选项为"No"，防止误触

详细说明：[删除表功能](./DELETE_TABLE_FEATURE.md)

### 4. AI查询优先使用SQL编辑器中的表 🆕

在AI查询时，如果SQL编辑器中已有脚本，当用户输入不限定表名时，AI会智能地优先使用编辑器中的表。

**使用场景**：
- 执行 `SELECT * FROM users` 后，输入"只看active的" → AI自动使用users表
- 查看订单数据后，输入"按金额排序" → AI基于当前orders表生成SQL
- 输入"查询name字段" → AI使用当前正在查看的表

**优势**：
- ⚡ 响应更快（跳过不必要的表选择）
- 🎯 更准确（避免选错表）
- 💰 节省Token消耗
- 🗣️ 更自然的交互方式

详细说明：[AI查询优先使用当前表](./AI_QUERY_CURRENT_TABLE_PRIORITY.md)

### 5. 智能识别现有表的命名规范（已更新到README）

在创建和修改表时，AI会自动分析当前数据库中已有表的结构，学习并遵循：
- 命名规范（表名、字段名风格）
- 字段类型选择习惯
- 主键设置方式
- 索引和约束的使用模式

**效果**：
- 新建的表与现有表保持一致的设计风格
- 整个数据库的结构更加规范统一
- 减少人工规范检查的工作量

## 🔧 技术改进

### 右键菜单增强

**表分类节点菜单**：
- 移除TABLE_CATEGORY的跳过逻辑
- 添加新建表和刷新菜单项
- 通过父节点获取数据库名
- 与数据库节点菜单保持一致

### 编辑表界面增强

**UI改进**：
- QLabel添加文本可选择标志
- 设置文本光标样式，提升用户体验
- 右键菜单添加复制功能

**新增方法**：
- `copy_selected_fields()` - 复制选中字段
- `copy_all_fields()` - 复制完整表结构
- 增强 `show_schema_table_menu()` - 添加复制选项

### 表管理功能增强

**新增方法**：
- `delete_table()` - 删除指定数据库中的表
  - 双重确认机制
  - 异步执行
  - 自动清理缓存
  - 更新树形视图

**菜单增强**：
- 表节点右键菜单新增"删除表"选项
- 统一使用垃圾桶图标
- 与删除数据库功能保持一致的交互体验

### AI客户端增强

**新增方法**：
- `_extract_table_names_from_sql()` - 从SQL语句中智能提取表名
- `_user_query_specifies_table()` - 判断用户查询是否明确指定表名

**改进方法**：
- `select_tables()` - 增加智能表优先选择逻辑

**支持的SQL格式**：
- 标准格式：`FROM users`
- 带反引号：`` FROM `users` ``
- 带引号：`FROM "users"`
- 带方括号：`FROM [users]`
- JOIN语句：`FROM orders JOIN customers`
- UPDATE/INSERT语句

### 提示词优化

**SELECT_TABLES_SYSTEM_PROMPT**（表选择提示词）：
- 新增"当前SQL优先原则"
- 强调优先使用标记为【当前SQL中的表】的表
- 优化工作流程说明

**GENERATE_SQL_SYSTEM_PROMPT**（SQL生成提示词）：
- 已包含"优先使用当前SQL"规则
- 已包含"当前SQL优先原则"说明

## 📖 文档更新

### 新增文档

1. **docs/AI_QUERY_CURRENT_TABLE_PRIORITY.md**
   - 详细说明AI查询优先使用当前表的功能
   - 包含使用场景、技术实现、测试结果
   - 提供最佳实践和使用建议

2. **docs/CHANGELOG_v1.2.0.md**（本文档）
   - 完整的版本更新说明

### 更新文档

1. **README.md & README_en.md**
   - 添加智能表选择功能说明
   - 添加使用技巧
   - 更新AI功能特性说明
   - 添加智能识别表规范的说明

## 🧪 测试

### 测试覆盖

✅ **表名提取测试**：
- 简单SELECT语句
- 带JOIN的语句
- 带反引号/引号的语句
- UPDATE/INSERT语句

✅ **用户查询判断测试**：
- 未指定表名的查询（"查询name字段"）
- 明确指定表名的查询（"查询users表"）
- 简短指令（"只看active的"）

### 测试结果

所有测试用例通过 ✅

## 🔄 兼容性

### 向后兼容

- ✅ 不影响现有功能
- ✅ SQL编辑器为空时，行为与之前完全相同
- ✅ 用户明确指定表名时，仍然正常选择对应的表

### 边界情况

- ✅ SQL编辑器为空 → 正常进行表选择
- ✅ 无法提取表名 → 正常进行表选择
- ✅ 用户明确指定其他表 → 使用用户指定的表
- ✅ 提取到多个表 → 全部传递给AI，让AI选择

## 📊 性能提升

- **响应速度**：跳过不必要的AI调用，查询响应更快
- **Token消耗**：减少表选择环节的Token消耗
- **准确率**：直接使用当前表，避免AI选错表的情况

## 🎯 用户体验改进

### 操作更简洁

**之前**：
```
1. SELECT * FROM users
2. 查看结果
3. 输入："在users表中查询status=active的用户"  ← 需要重复指定表名
```

**现在**：
```
1. SELECT * FROM users
2. 查看结果
3. 输入："只看active的"  ← 简短自然
```

### 交互更自然

用户可以使用更口语化的指令：
- "只看active的"
- "按时间排序"
- "取前10条"
- "只要name和email"

## 🐛 Bug修复

### 删除表时缓存清理错误 (v1.2.1)

**问题**：
- 删除表成功后，清理缓存时出现导入错误
- 错误信息：`ImportError: cannot import name 'schema_cache'`

**原因**：
- 错误地导入了不存在的 `schema_cache` 实例
- 应该使用 `get_schema_cache()` 函数获取单例实例

**修复**：
- 修改为正确的单例模式使用方式
- 使用公共API `clear_connection_cache()` 清理缓存
- 清理更彻底，不会遗留缓存

**影响**：
- 不影响表删除功能本身
- 只影响缓存清理部分
- 修复后无任何错误提示

详细说明：[Bug修复文档](./BUGFIX_DELETE_TABLE_CACHE.md)

## 🐛 已知问题

无

## 📋 下一步计划

- [ ] 支持更复杂的SQL解析（子查询、CTE等）
- [ ] 记住用户最近查看的表
- [ ] 支持从SQL注释中提取上下文
- [ ] 支持多表JOIN场景的智能识别

## 👥 贡献者

- codeyG (550187704@qq.com)

## 📜 许可证

MIT License

---

**完整更新内容请查看相关文档**：
- [AI查询优先使用当前表](./AI_QUERY_CURRENT_TABLE_PRIORITY.md)
- [AI模型使用说明](./AI_MODEL_USAGE.md)
- [README](../README.md)


